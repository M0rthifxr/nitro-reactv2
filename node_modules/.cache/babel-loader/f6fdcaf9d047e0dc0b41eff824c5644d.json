{"ast":null,"code":"import{FontAwesomeIcon}from'@fortawesome/react-fontawesome';import{FollowFriendMessageComposer}from'@nitrots/nitro-renderer';import{useEffect,useRef,useState}from'react';import{AddEventLinkTracker,GetSessionDataManager,GetUserProfile,LocalizeText,RemoveLinkEventTracker,ReportType,SendMessageComposer}from'../../../../api';import{Base,Button,ButtonGroup,Column,Flex,Grid,LayoutAvatarImageView,LayoutBadgeImageView,LayoutGridItem,LayoutItemCountView,NitroCardContentView,NitroCardHeaderView,NitroCardView,Text}from'../../../../common';import{useHelp,useMessenger}from'../../../../hooks';import{FriendsMessengerThreadView}from'./messenger-thread/FriendsMessengerThreadView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export const FriendsMessengerView=props=>{const[isVisible,setIsVisible]=useState(false);const[lastThreadId,setLastThreadId]=useState(-1);const[messageText,setMessageText]=useState('');const{visibleThreads=[],activeThread=null,getMessageThread=null,sendMessage=null,setActiveThreadId=null,closeThread=null}=useMessenger();const{report=null}=useHelp();const messagesBox=useRef();const followFriend=()=>activeThread&&activeThread.participant&&SendMessageComposer(new FollowFriendMessageComposer(activeThread.participant.id));const openProfile=()=>activeThread&&activeThread.participant&&GetUserProfile(activeThread.participant.id);const send=()=>{if(!activeThread||!messageText.length)return;sendMessage(activeThread,GetSessionDataManager().userId,messageText);setMessageText('');};const onKeyDown=event=>{if(event.key!=='Enter')return;send();};useEffect(()=>{const linkTracker={linkReceived:url=>{const parts=url.split('/');if(parts.length===2){if(parts[1]==='open'){setIsVisible(true);return;}if(parts[1]==='toggle'){setIsVisible(prevValue=>!prevValue);return;}const thread=getMessageThread(parseInt(parts[1]));if(!thread)return;setActiveThreadId(thread.threadId);setIsVisible(true);}},eventUrlPrefix:'friends-messenger/'};AddEventLinkTracker(linkTracker);return()=>RemoveLinkEventTracker(linkTracker);},[getMessageThread,setActiveThreadId]);useEffect(()=>{if(!isVisible||!activeThread)return;messagesBox.current.scrollTop=messagesBox.current.scrollHeight;},[isVisible,activeThread]);useEffect(()=>{if(isVisible&&!activeThread){if(lastThreadId>0){setActiveThreadId(lastThreadId);}else{if(visibleThreads.length>0)setActiveThreadId(visibleThreads[0].threadId);}return;}if(!isVisible&&activeThread){setLastThreadId(activeThread.threadId);setActiveThreadId(-1);}},[isVisible,activeThread,lastThreadId,visibleThreads,setActiveThreadId]);if(!isVisible)return null;return/*#__PURE__*/_jsxs(NitroCardView,{className:\"nitro-friends-messenger\",uniqueKey:\"nitro-friends-messenger\",theme:\"primary-slim\",children:[/*#__PURE__*/_jsx(NitroCardHeaderView,{headerText:LocalizeText('messenger.window.title',['OPEN_CHAT_COUNT'],[visibleThreads.length.toString()]),onCloseClick:event=>setIsVisible(false)}),/*#__PURE__*/_jsx(NitroCardContentView,{children:/*#__PURE__*/_jsxs(Grid,{overflow:\"hidden\",children:[/*#__PURE__*/_jsxs(Column,{size:4,children:[/*#__PURE__*/_jsx(Text,{bold:true,children:LocalizeText('toolbar.icon.label.messenger')}),/*#__PURE__*/_jsx(Column,{fullHeight:true,overflow:\"auto\",children:visibleThreads&&visibleThreads.length>0&&visibleThreads.map(thread=>{return/*#__PURE__*/_jsxs(LayoutGridItem,{itemActive:activeThread===thread,onClick:event=>setActiveThreadId(thread.threadId),children:[thread.unread&&/*#__PURE__*/_jsx(LayoutItemCountView,{count:thread.unreadCount}),/*#__PURE__*/_jsxs(Flex,{fullWidth:true,alignItems:\"center\",gap:1,children:[/*#__PURE__*/_jsxs(Flex,{alignItems:\"center\",className:\"friend-head px-1\",children:[thread.participant.id>0&&/*#__PURE__*/_jsx(LayoutAvatarImageView,{figure:thread.participant.figure,headOnly:true,direction:3}),thread.participant.id<=0&&/*#__PURE__*/_jsx(LayoutBadgeImageView,{isGroup:true,badgeCode:thread.participant.figure})]}),/*#__PURE__*/_jsx(Text,{truncate:true,grow:true,children:thread.participant.name})]})]},thread.threadId);})})]}),/*#__PURE__*/_jsx(Column,{size:8,overflow:\"hidden\",children:activeThread&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Text,{bold:true,center:true,children:LocalizeText('messenger.window.separator',['FRIEND_NAME'],[activeThread.participant.name])}),/*#__PURE__*/_jsxs(Flex,{alignItems:\"center\",justifyContent:\"between\",gap:1,children:[/*#__PURE__*/_jsxs(Flex,{gap:1,children:[/*#__PURE__*/_jsxs(ButtonGroup,{children:[/*#__PURE__*/_jsx(Button,{onClick:followFriend,children:/*#__PURE__*/_jsx(Base,{className:\"nitro-friends-spritesheet icon-follow\"})}),/*#__PURE__*/_jsx(Button,{onClick:openProfile,children:/*#__PURE__*/_jsx(Base,{className:\"nitro-friends-spritesheet icon-profile-sm\"})})]}),/*#__PURE__*/_jsx(Button,{variant:\"danger\",onClick:()=>report(ReportType.IM,{reportedUserId:activeThread.participant.id}),children:LocalizeText('messenger.window.button.report')})]}),/*#__PURE__*/_jsx(Button,{onClick:event=>closeThread(activeThread.threadId),children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:\"times\"})})]}),/*#__PURE__*/_jsx(Column,{fit:true,className:\"bg-muted p-2 rounded chat-messages\",children:/*#__PURE__*/_jsx(Column,{innerRef:messagesBox,overflow:\"auto\",children:/*#__PURE__*/_jsx(FriendsMessengerThreadView,{thread:activeThread})})}),/*#__PURE__*/_jsxs(Flex,{gap:1,children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"form-control form-control-sm\",maxLength:255,placeholder:LocalizeText('messenger.window.input.default',['FRIEND_NAME'],[activeThread.participant.name]),value:messageText,onChange:event=>setMessageText(event.target.value),onKeyDown:onKeyDown}),/*#__PURE__*/_jsx(Button,{variant:\"success\",onClick:send,children:LocalizeText('widgets.chatinput.say')})]})]})})]})})]});};","map":null,"metadata":{},"sourceType":"module"}